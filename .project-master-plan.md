# Gemaş B2B Project Master Plan

## Proje Vizyonu
Gemaş markalı havuz ekipmanlarının satışını yapan, bayiler için özelleştirilmiş B2B e-ticaret platformudur. Bayilerin ürünleri inceleyebileceği, özel fiyatlarla teklif oluşturabileceği ve sipariş verebileceği, arka planda Logo Tiger ERP ile tam entegre çalışan bir sistemdir.

## Teknoloji Yığını (Mevcut Durum)
> **Not:** Proje kök dizinindeki dosyalar PHP tabanlıdır. Kullanıcı isteminde belirtilen Next.js yapısı muhtemelen gelecek vizyonu veya farklı bir repodur. Bu doküman **mevcut aktif PHP yapısını** baz almaktadır.

- **Backend:** Native PHP (Legacy/Custom Framework yapısı)
- **Frontend:** HTML5, CSS3, JavaScript (jQuery yoğunluklu), Bootstrap
- **Veritabanı:** MySQL / MariaDB
- **Entegrasyon:** Logo Tiger ERP (MSSQL) - PHP PDO/SQLSRV üzerinden haberleşme
- **Paket Yöneticisi:** Composer (PHP), NPM (kısmi kullanım)
- **Alt Projeler:** 
  - `B2B GEMAS`: Laravel tabanlı (API veya yeni versiyon adayı)
  - `test_project`: PHP (Test ortamı)

## Mimari ve Klasör Yapısı

Ana dizin (`/`) içerisindeki kritik klasörler ve görevleri:

- **/api**: Önyüzden yapılan AJAX isteklerini karşılayan PHP endpoint'leri.
  - `/api/kampanya`: Kampanya hesaplamaları ve koşul kontrolleri (örn: `check_conditions.php`).
  - `/api/urun`: Ürün bilgileri ve satış verileri servisleri.
- **/assets**: CSS, JS, Resim ve Font dosyaları.
  - `/assets/js`: Özel JS modülleri (örn: `campaign_logic.js`).
  - `/assets/css`: Stil dosyaları.
- **/classes**: Helper sınıfları ve veritabanı wrapper'ları.
- **/config**: Veritabanı bağlantı ayarları ve sabitler.
- **/includes** & **/include**: Tekrar kullanılan PHP parça dosyaları (header, footer, modal vb.).
- **/logs**: Sistem ve hata logları.
- **/services**: Logo ERP ile konuşan servis katmanı dosyaları.
- **Kök Dizindeki Kritik Dosyalar:**
  - `teklif-olustur.php`: Sistemin kalbi. Sipariş oluşturma, ürün seçimi, sepet yönetimi ve fiyatlandırma burada döner.
  - `siparis-olustur.php`: Sepetin onaylanıp siparişe dönüştüğü aşama.
  - `index.php`: Giriş noktası / Dashboard.
  - `fonk.php`: Genel yardımcı fonksiyonlar.

## Veritabanı ve Veri Akışı

### Veritabanı Şeması (MySQL)
Proje yerel MySQL veritabanı üzerinde çalışır ancak asıl veri kaynağı Logo Tiger ERP (MSSQL)'dir.

- **urunler**: Ürün ana tablosu (Logo'dan senkronize edilir).
  - `urun_id`, `stok_kodu`, `stok_adi`, `fiyat`, `doviz`
- **sozlesmeler**: Müşteri sözleşmeleri.
- **kampanyalar**: Özel kampanya tanımları.
- **yonetici**: Kullanıcı ve yetki tablosu.

### Veri Akışı (Logo ERP Entegrasyonu)
1.  **Senkronizasyon:** `urunler_senkron.php` gibi scriptler ile Logo Tiger'dan (MSSQL) ürün, stok ve cari bilgileri çekilip MySQL'e yazılır.
2.  **Canlı Sorgu:** Sipariş anında stok durumu veya risk analizi için Logo'ya anlık sorgular atılabilir (`services/` altındaki dosyalar).
3.  **Sipariş Gönderimi:** B2B üzerinden oluşturulan siparişler, onaylandıktan sonra Logo REST API veya direkt veritabanı insert işlemi ile Logo'ya "Satış Siparişi" olarak aktarılır.

## Kritik İş Akışları

### 1. Teklif ve Sipariş Oluşturma (`teklif-olustur.php`)
1.  **Ürün Seçimi:** Kullanıcı "Ürün Ekle" modalları veya satır içi arama ile ürünleri seçer.
2.  **Fiyatlandırma:**
    - Ürün baz fiyatı veritabanından gelir.
    - Cari iskontosu otomatik uygulanır.
    - **Kampanya Sistemi (`campaign_logic.js`):** Sepet içeriği `check_conditions.php` ye gönderilir. Eğer koşul sağlanırsa (örn: X grubundan 10 adet), kullanıcıya özel fiyat uygulama seçeneği sunulur.
3.  **Sepet Yönetimi:** Seçilen ürünler Cookie veya Session bazlı saklanır.
4.  **Onay:** Sepet son haline gelince "Sipariş Oluştur" ile `siparis-olustur.php`ye yönlendirilir.

### 2. Kampanya Yönetimi
- **Tanımlama:** Kampanya kuralları veritabanında veya kod içinde (`check_conditions.php`) tanımlanır.
- **Uygulama:** Kullanıcı "Kampanya Uygula" butonuna basar.
- **Sonuç:** Liste fiyatları (`fiyatsi` inputu) özel kampanya fiyatıyla değişir ve satır yeşil renk alır.

## Geliştirme Kuralları

1.  **Kod Standartları:**
    - PHP dosyalarında `<?php` tagı ile başla.
    - Değişken isimlendirmelerinde `camelCase` veya `snake_case` tutarlı kullanılmalı (Mevcut proje `snake_case` ağırlıklı).
    - SQL Enjeksiyonuna karşı `Prepared Statements` kullanılmalı.
2.  **Frontend:**
    - jQuery olay yönetiminde `$(document).on('click', selector)` (delegation) tercih edilmeli. Dinamik elementler için bu şarttır.
    - CSS değişiklikleri `assets/css` altında toplanmalı, inline CSS den kaçınılmalı (Mümkünse).
3.  **Güvenlik:**
    - Hassas işlemlerden önce `oturumkontrol()` fonksiyonu çağrılmalı.
    - User input'lar `xss()` veya filtreleme fonksiyonlarından geçirilmeli.
4.  **Git Kuralı:**
    - Her özellik için yeni bir branch açılmalı (Agent modunda direkt commit yapsak da konsept bu).
    - `task.md` dosyası her büyük değişiklikte güncellenmeli.


## Operasyonel Harita ve Entegrasyonlar

### 1. Logo Tiger ERP Entegrasyonu (`classes/LogoService.php`)
Sistem, Logo Tiger ERP ile REST API üzerinden haberleşir. Bu servis, veri tutarlılığını ve çift yönlü senkronizasyonu sağlar.

- **Sınıf:** `Proje\LogoService`
- **Konum:** `classes/LogoService.php`
- **Temel Görevler:**
  - **ARP (Cari) Yönetimi:** `createArp`, `updateArp`. Veritabanındaki müşteri bilgilerini Logo'daki Cari Kartlar ile eşler.
  - **Sipariş Aktarımı:** `transferOrder`.
    - B2B üzerindeki siparişi (`ogteklif2` ve kalemleri) okur.
    - Ürünlerdeki **Kademeli İskonto** ("50-5-10") yapısını ayrıştırır ve her bir iskonto oranını Logo'ya ayrı birer `TYPE=2` (İskonto Satırı) olarak ekler.
    - Döviz kurlarını (`TC_XRATE`) ve türlerini (`CURRSEL_TOTAL`, `CURR_TYPE`) e-Fatura standartlarına (TL=160, USD=1, EUR=20) göre ayarlar.
    - Başarılı aktarım sonrası Logo'dan dönen `INTERNAL_REFERENCE` ve `FICHENO` bilgilerini yerel veritabanına geri yazar.

### 2. WhatsApp Onay Süreci (n8n Entegrasyonu)
Tekliflerin yönetici onayı için WhatsApp üzerinden otomatik mesajlaşma ve butonla onay sistemi kurulmuştur.

#### A. Onay İsteği Gönderme
- **Tetikleyici:** Yöneticiye onay gönderildiğinde.
- **Dosya:** `api/teklif/onay-gonder.php`
- **Akış:**
  1. Teklif verisi JSON olarak hazırlanır.
  2. `https://flow.gemas.com.tr/webhook/teklifOnay` adresindeki n8n webhook'una POST edilir.
  3. n8n, WhatsApp API (Evolution API) üzerinden yöneticiye mesaj atar.

#### B. Onay/Red Cevabı (Callback Hali)
- **Tetikleyici:** Yönetici WhatsApp'tan butona bastığında veya cevap yazdığında.
- **Proxy:** `api/webhook_proxy.php`
  - Gelen tüm mesajları karşılar.
  - Botun kendi mesajlarını (`fromMe`) filtreler.
  - Geçerli mesajları n8n'e (`.../webhook/teklifOnayCevap`) yönlendirir.
- **İşleyici:** `api/teklif/n8n_callback.php`
  - n8n, kullanıcının cevabını işleyip bu dosyaya POST eder.
  - **Güvenlik:** `gemas_secret_n8n_token_2025` token'ı ile doğrulanır.
  - **İşlem:** `teklif_decisions` tablosuna kararı loglar ve `ogteklif2` tablosundaki `approval_status` alanını günceller (`approved`/`rejected`).

### 3. Veritabanı ve Kritik Tablolar
- `ogteklif2`: Sipariş başlık bilgileri (Durum, Cari, Tutar).
- `ogteklif2_detay`: Sipariş kalemleri (Ürün, Miktar, Fiyat).
- `teklif_decisions`: Yönetici onay logları (Hangi mesaj ID ile ne zaman onaylandı).
- `durum_gecisleri`: Siparişin durum tarihçesi.

## Proje Dosya Sözlüğü (File Dictionary)

### 1. Ana Uygulama (Kök Dizin - Native PHP)
Bu dizin projenin ana omurgasını oluşturur. Dosyalar genellikle direkt URL ile çağrılır (Örn: `domain.com/teklif-olustur.php`).

**Temel İş Akışı Sayfaları:**
- `index.php`: Dashboard / Giriş sonrası ana ekran.
- `teklif-olustur.php`: **[KRİTİK]** Sipariş oluşturma sihirbazı. Ürün seçimi, kampanya kontrolü ve sepet yönetimi.
- `siparis-olustur.php`: Sepeti onaya gönderme ve sonlandırma sayfası.
- `sipariskontrol.php`: Verilen siparişlerin listelendiği, filtrelendiği ve durumu değiştirildiği yönetim ekranı.
- `teklif-olustur-revize.php` / `teklif-duzenle.php`: Mevcut teklifleri düzenleme versiyonları.

**Yönetim ve Entegrasyon Panelleri:**
- `admin_logo_transfer.php`: Onaylanan siparişlerin Logo ERP'ye aktarılmasını sağlayan kuyruk yönetim ekranı.
- `arasentegrasyon.php`: Aras Kargo entegrasyonu durum ekranı (Yapım aşamasında).
- `beklemedekiuyeler.php` / `bekleyenhesaponayinikaldir.php`: Bayi üyelik onay yönetimi.
- `bultenler.php` / `bultensil.php`: Duyuru ve bülten yönetim sistemi.
- `yonetici.php`: Yönetici (Admin) kullanıcılarının tanımlandığı yer (varsa).

**Raporlama ve Analiz:**
- `cari-durum-analiz.php`: Müşteri bazlı finansal analiz ve ekstre görüntüleme.
- `ozel-fiyat-listesi.php` / `ozel-fiyat-olustur.php`: Müşteriye özel fiyat tanımlamaları.
- `urundetay.php` / `urunler.php`: Ürün kataloğu ve detay sayfaları.

**Oturum ve Çekirdek:**
- `giris.php`: Login sayfası.
- `cikisyap.php` / `cikis.php`: Oturum sonlandırma.
- `fonk.php`: **[KRİTİK]** Veritabanı bağlantısı (`$db`), `LogoService` başlangıcı ve global fonksiyonlar.

### 2. Alt Proje: Bayi Paneli (`/bayi`)
Kök dizinin altında yer alan **Laravel** framework'ü ile yazılmış bağımsız bir alt projedir. Muhtemelen yeni nesil arayüz veya API servisidir.
- **Yapı:** `artisan`, `composer.json`, `app/`, `routes/`, `resources/` klasörlerini içerir.
- **Önem:** Mevcut PHP yapısından bağımsız çalışır ancak veritabanını ortak kullanıyor olabilir.

### 3. API Servisleri (`/api`)
JavaScript (AJAX) isteklerini karşılayan backend servis uçlarıdır.

**Bölüm: Teklif ve Onay (`/api/teklif`)**
- `onay-gonder.php`: Yöneticiye n8n üzerinden WhatsApp onayı tetikler.
- `n8n_callback.php`: WhatsApp'tan gelen cevapları (Onay/Red) veritabanına işler.
- `check_decision.php`: Onay durumunu kontrol eder.
- `save_key_id.php`: Mesaj ID takibi.

**Bölüm: Kampanya (`/api/kampanya`)**
- `check_conditions.php`: Sepetin kampanya kurallarına uygunluğunu denetler.
- `get_special_prices.php`: Hak edilen kampanyalı fiyatları hesaplar.
- `add_product.php`: Kampanya kapsamına ürün ekler (Admin paneli için).

**Bölüm: Ürün ve Fiyat (`/api/urun`, `/api/fiyat`)**
- `get_product_price.php` / `get_product_stock.php`: Anlık fiyat ve Logo stok sorgusu.
- `check_session.php` / `clear_session.php`: Sepet oturum yönetimi.
- `add_to_queue.php` / `process_queue.php`: Logo aktarım kuyruğuna ekleme ve işleme worker'ı.

**Genel (`/api`)**
- `webhook_proxy.php`: Dış dünyadan (WhatsApp/n8n) gelen webhookları güvenli şekilde içeri alır.
- `get_payment_delays.php`: Ödeme gecikme raporu servisi.

### 4. Servisler ve Sınıflar (`/classes`, `/services`)
Modern OOP yapısında yazılmış, iş mantığını taşıyan dosyalar.
- `classes/LogoService.php`: **[KRİTİK]** Logo ERP entegrasyonu (Sipariş, Cari, İskonto).
- `classes/DatabaseManager.php`: MySQL işlemleri için wrapper sınıf.
- `classes/RestClient.php` ve `classes/TokenManager.php`: Logo REST API iletişimi.
- `services/PriceUpdater.php`: Toplu fiyat güncelleme mantığı.
- `services/MaterialService.php`: Malzeme yönetimi.

### 5. Bakım, Geliştirme ve Test Araçları (Kök Dizin)
Bu dosyalar genelde geliştirici tarafından manuel çağrılır veya cron ile çalışır.

**Şema ve Migration Araçları:**
- `add_column.php`, `add_n8n_col.php`, `add_discount_column.php`: Veritabanına yeni alanlar ekleyen tek seferlik scriptler.
- `check_schema.php`, `check_table_schema.php`: Veritabanı yapısını kontrol eden diagnostic araçları.

**Veri Kontrol ve Onarım:**
- `check_data.php`, `check_db_data.php`: Veri tutarlılığını test eder.
- `fix_*.php` (Varsa): Hatalı verileri düzelten scriptler.

**Test ve Debug:**
- `test_*.php` (örn: `create_test_offer.php`, `check_decision_test.php`): Özellikleri izole test etmek için.
- `debug_*.php`: Hata ayıklama çıktıları verir.

### 6. Kütüphaneler (`/include`, `/includes`)
- `include/vt.php`: Veritabanı konfigürasyonu.
- `include/fonksiyon.php`: Eski usül fonksiyon kütüphanesi.
- `includes/class.phpmailer.php`: SMTP mail gönderimi.
- `includes/fiyat_talep_modal.php`: HTML parça dosyaları (Partial views).

**Diğer Dosyalar:**
- `campaign_logic.js`: Kampanya mantığını yöneten JS dosyası (Kök dizinde duruyor).
- `kampanyafiyat.txt`: Muhtemelen kampanya fiyat tanımları için kullanılan geçici veya config dosyası.


Logo MSSQL Technical Report
This report maps the integration point between the Gemaş B2B Portal and the Logo Tiger ERP (MSSQL) system.

1. Connection Architecture
The application connects to Logo MSSQL using two primary methods:

Direct PDO (SQLSRV):

Driver: sqlsrv (via PHP PDO).
Configuration: Connection details (Host, DB, User, Pass) are often sourced from 
include/vt.php
, 
.env
, or hardcoded in older scripts.
Multi-Company Support: The system maintains separate connections for different companies/periods:
$gempaLogoDB / $baglantiGEMPA: Connects to GEMPA databases (e.g., GEMPA2026).
$gemasLogoDB / $baglantiGEMAS: Connects to GEMAS databases (e.g., GEMAS2026).
Files: 
fonk.php
 (initializes global connections), 
urunler_senkron.php
, 
services/PriceUpdater.php
.
REST API (Hybrid):

Class: Proje\LogoService.
Mechanism: Uses 
classes/RestClient.php
 to talk to the Logo REST API service (likely running on an intermediary server or the Logo server itself).
Usage: Primarily for Transactional Writes (Creating Orders, creating ARPs) to ensure business logic integrity.
2. Schema Discovery (Critical Tables)
The system interacts with the following Logo Tiger tables. Note that XXX represents the Firm Number (e.g., 566, 526) and YY represents the Period (e.g., 01).

A. Products & Stock (Read/Write)
LG_XXX_ITEMS: Main product card table.
Read: Stock codes, names, VAT rates.
Write: ACTIVE status updates, Name translations (NAME3, NAME4).
LG_XXX_PRCLIST: Price lists.
Read/Write: Sales and Purchasing prices (PTYPE=2 vs 1).
LG_XXX_UNITSETL: Unit definitions (Pieces, Sets).
B. Sales & Orders (Read via SQL, Write via API)
LG_XXX_YY_ORFICHE: Order Fiches (Headers).
LG_XXX_YY_ORFLINE: Order Transactions (Lines).
Usage: calculating past sales, checking status.
LG_XXX_PAYPLANS: Payment plans.
C. Finance & ARP (Read/Write)
LG_XXX_CLCARD: Client/Vendor Cards (ARP).
LG_XXX_YY_CLFLINE: Client Transactions (Debts/Credits).
Usage: Calculating current balance and risk.
3. Data Logic Mapping
Domain	Key Files	Mechanism	Tables / Endpoints
Orders	
classes/LogoService.php
REST API	POST salesOrders (Maps to ORFICHE/ORFLINE)
Proposals	
teklif-olustur.php
Local DB	Stored in MySQL ogteklif2, not sent to Logo until approved.
Items	
urunler_senkron.php
PDO (Read)	Syncs LG_XXX_ITEMS -> MySQL urunler.
Prices	
services/PriceUpdater.php
PDO (Write)	Direct UPDATE to LG_XXX_PRCLIST.
Stock	
api/urun/get_product_stock.php
PDO (Read)	Queries LG_XXX_ITEMS joined with STINVTOT (likely).
ARP/Cari	
classes/LogoService.php
REST API	POST Arps, GET Arps (Maps to CLCARD).
4. Query Patterns
Dynamic Firm Numbers: Queries use variables for table prefixes (e.g., LG_{$firmNr}_ITEMS), making them adaptable to year changes (2025 -> 2026).
Complex Joins: Sync scripts (
urunler_senkron.php
) perform heavy joins across ITEMS, PRCLIST, and UNITSETL to build a complete local product view.
Cross-Database Queries: Some queries explicitly reference the database name [GEMAS2026].[dbo].[LG_526_ITEMS], which implies the SQL user needs permissions across multiple DBs.
5. Sensitive Areas (Direct Write Operations)
WARNING: The following files perform direct UPDATE operations on the Logo Database. These are high-risk areas.

services/PriceUpdater.php

Action: Updates ACTIVE status of items.
Query: UPDATE LG_XXX_ITEMS SET ACTIVE = ? WHERE LOGICALREF = ?
Risk: Can deactivate products in the ERP.
services/ProductTranslationService.php

Action: Updates product descriptions.
Query: UPDATE LG_XXX_ITEMS SET NAME = ? WHERE LOGICALREF = ?
Risk: Overwrites ERP master data.
services/LogoPriceUpsertRepository.php

Action: Updates or Inserts prices.
Query: INSERT INTO / UPDATE LG_XXX_PRCLIST ...
Risk: Directly changes pricing in ERP.
test_logo_campaigns.php

Action: Deactivates campaigns.
Query: UPDATE LG_XXX_CAMPAIGN SET ACTIVE = 0 ...
Conclusion & Recommendations
Mixed Mode: The system is in a "Mixed Mode" state, using modern REST API for complex transactions (Orders) but legacy Direct SQL for bulk updates (Prices, Sync).
Firm Transition: The code is designed to handle different firm numbers (525/526, 565/566), which corresponds to the 2025/2026 period transition.
Safety Rule: Any new agent task involving `PriceUpdater.php` or `ProductTranslationService.php` must be treated with extreme caution as they bypass the API validation layer.

## 6. Logo Firm Transition (Yearly Updates)

The system does **NOT** use a central configuration for Logo Firm Numbers (e.g., 525 vs 526). These values are **hardcoded** across multiple files. For the 2026 transition (525/565 -> 526/566), the following files must be updated:

### 1. Database Connections & Sync
*   **`urunler_senkron.php`**:
    *   **DB Name:** Update `Database=GEMPA2025` -> `GEMPA2026` and `GEMAS2025` -> `GEMAS2026` in DSN strings.
    *   **Table Joins:** Update `[GEMAS2025].[dbo].[LG_525_ITEMS]` -> `[GEMAS2026].[dbo].[LG_526_ITEMS]`.
    *   **Column Names:** The local MySQL `urunler` table uses year-specific columns like `GEMAS2026LOGICAL` and `GEMPA2026LOGICAL`. Ensure these columns exist in MySQL and are referenced correctly in the `INSERT/UPDATE` queries.

### 2. Price Update Logic
*   **`services/PriceUpdater.php`**:
    *   Update table references in `updateGempaLogoPrice` methods (e.g., `LG_565_PRCLIST` -> `LG_566_PRCLIST`).
    *   Update `LG_525_*` -> `LG_526_*` for Gemas calls.
*   **`src/Repositories/LogoPriceUpsertRepository.php`**:
    *   **Allowed Tables:** Update the `$allowed` array: `['LG_565_PRCLIST', 'LG_525_PRCLIST']` -> `['LG_566_PRCLIST', 'LG_526_PRCLIST']`.
    *   The class dynamically derives `UNITSETL` and `PRCLSTDIV` table names from the input table prefix, so updating the allow-list is usually sufficient *if* the prefix logic holds (3 chars).

### 3. Product Translations
*   **`services/ProductTranslationService.php`**:
    *   Update direct SQL `UPDATE LG_525_ITEMS...` queries to target `LG_526_ITEMS`.
    *   Update `GEMAS2025LOGICAL` column references to `GEMAS2026LOGICAL`.

### 4. Other Scripts
*   **`test_risk_data.php`**: Update `checkRiskData` parameters.
### 5. API Güncellemeleri (Ocak 2026)
*   **`api/urun/get_product_sales_summary.php`**:
    *   **Eski Yapı:** Direkt `LG_XXX_01_STLINE` tablosuna karmaşık JOIN sorguları atıyordu.
    *   **Yeni Yapı:** Logo veritabanındaki **View**'ları (`LV_{FirmaKodu}_SALES_ITEMS`) kullanacak şekilde güncellendi.
    *   **Firma Kodu:** Yıla göre dinamik hesaplanır (2024->564, 2025->565, 2026->566).
    *   **Veri Kaynağı:** Kullanıcı isteği üzerine **SADECE GEMPA** (Firma 566) verilerini baz alır. GEMAS (Firma 526) verileri toplama dahil edilmez.
    *   **Test Scripti:** `test_sales_api_local.php` ile doğrulanmıştır.

### 6. Ana Bayi Ek İskonto Sistemi (23 Ocak 2026)
*   **Genel Bakış:** Ana Bayi müşteriler için özel fiyat kampanyalarına ek %5 iskonto sistemi eklendi.
*   **Koşullar:**
    *   Özel Fiyat: Kategori bazlı minimum 10 adet
    *   Ana Bayi Ek İskonto: Minimum 5000 EUR toplam tutar (özel fiyat üzerinden hesaplanır)
    *   Uygulama sırası: Önce özel fiyat, sonra Ana Bayi iskontosu
*   **Backend (`api/kampanya/check_conditions.php`):**
    *   Lines 81-91: Ana Bayi tespiti (customer_name'de "ERTEK" veya "Ana Bayi" kontrolü)
    *   Lines 93-127: Özel fiyatlı ürünlerin toplam EUR hesaplama
    *   Lines 129-140: 5000 EUR kontrolü ve kampanya objesi oluşturma
*   **Frontend (`campaign_logic.js`):**
    *   Lines 61-65: AJAX request'e customer_id ve customer_name ekleme
    *   Lines 107-138: Modal HTML - Ana Bayi için sarı/warning card styling
    *   Lines 203-237: `applyExtraDiscountToTable()` - Readonly validation ile %5 iskonto uygulama
8N Yönetici Onay Sistemi - Teknik Dokümantasyon
Genel Bakış
"Yönetici onayına gönder" butonuna basıldığında, sistem özel teklifleri n8n webhook'u üzerinden WhatsApp ile yöneticiye gönderir.

İşlem Akışı
1. Teklif Oluşturma (sipariskontrol.php)
Dosya: 
…\b2b-gemas-project-main\sipariskontrol.php

Satır: 476-547

Tetikleme Koşulu
if ($isSpecialOffer) {
    // Özel teklif checkbox'ı işaretli ise
    $approvalStatus = 'pending';
    $durumu = 'Yönetici Onayı Bekleniyor';
}
İstek Hazırlama (Satır 481-488)
$approvalData = [
    "yonetici_tel" => $sistemayar['whatsapp_approval_phone'] ?? "905525287286",
    "cari"         => $musteriadi,
    "toplam"       => number_format((float)$genelToplam, 2, '.', ''),
    "teklif_id"    => (int)$teklifsonkayitid,
    "temsilci"     => $temsilciAdi,
    "urunler"      => $approvalProducts
];
API URL Oluşturma (Satır 490-494)
$protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off' || $_SERVER['SERVER_PORT'] == 443) 
    ? "https://" : "http://";
$domainName = $_SERVER['HTTP_HOST'];
$baseDir = dirname($_SERVER['PHP_SELF']);
$apiUrl = $protocol . $domainName . $baseDir . "/api/teklif/onay-gonder.php";
Örnek URL: https://satis.gemas.com.tr/api/teklif/onay-gonder.php

2. Ara API (onay-gonder.php)
Dosya: 
…\api\teklif\onay-gonder.php

Satır: 12

N8N Webhook URL
$webhookUrl = "https://flow.gemas.com.tr/webhook/teklifOnay";
İşlev
Gelen isteği JSON olarak okur
İsteği onay-gonder.log dosyasına kaydeder
cURL ile n8n webhook'una iletir
n8n'den gelen yanıtı döndürür
Debug Log Konumu
c:\xampp\htdocs\b2b-gemas-project-main\api\teklif\onay-gonder.log
3. N8N Webhook
URL: https://flow.gemas.com.tr/webhook/teklifOnay
Method: POST
Content-Type: application/json

Gönderilen Veri Yapısı
{
  "yonetici_tel": "905525287286",
  "cari": "Firma Adı",
  "toplam": "15000.00",
  "teklif_id": 123,
  "temsilci": "Ahmet Yılmaz",
  "urunler": [
    {
      "ad": "Ürün Adı",
      "adet": 5,
      "fiyat": 3000.00
    }
  ]
}
4. WhatsApp Mesaj ID Kaydetme
Dosya: 
sipariskontrol.php

Satır: 514-545

Yanıt İşleme
$respJson = json_decode($apiResponse, true);
// WhatsApp Message ID'yi bul
foreach ($iterator as $key => $value) {
    if ($key === 'id' && strlen($value) > 18 && strpos($value, '-') === false) {
        $foundId = $value;
        break;
    }
}
// Veritabanına kaydet
if (!empty($foundId)) {
    $updInst = $db->prepare("UPDATE ogteklif2 SET n8n_instance_id = ? WHERE id = ?");
    $updInst->bind_param("si", $foundId, $teklifsonkayitid);
    $updInst->execute();
}
Konfigürasyon
Environment Variables (.env)
WHATSAPP_APPROVAL_PHONE=905525287286
Sistem Ayarları (sistemayar tablosu)
whatsapp_approval_phone: Yöneticinin WhatsApp telefon numarası
Debug ve Hata Ayıklama
Log Dosyaları
onay-gonder.log

Konum: 
c:\xampp\htdocs\b2b-gemas-project-main\api\teklif\onay-gonder.log
İçerik: API istekleri ve n8n yanıtları
n8n_capture.txt

Konum: 
…\b2b-gemas-project-main\n8n_capture.txt
İçerik: n8n API yanıtları
Test Etme
Özel teklif checkbox'ını işaretle
Teklifi kaydet
Log dosyalarını kontrol et:
tail -f api/teklif/onay-gonder.log
n8n dashboard'dan webhook'u izle
Güvenlik Notları
⚠️ SSL Doğrulama Devre Dışı

curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
Production ortamında bu ayarlar düzeltilmeli ve geçerli SSL sertifikaları kullanılmalıdır.

Olası Hatalar ve Çözümleri
1. Webhook Ulaşılamıyor
n8n servisinin çalıştığını kontrol et
Firewall kurallarını kontrol et
SSL sertifikasını kontrol et
2. Message ID Kaydedilmiyor
n8n yanıt yapısını kontrol et
Log dosyasından yanıtı incele
key.id veya keyId alanlarının varlığını doğrula
3. WhatsApp Mesajı Gönderilmiyor
Evolution API bağlantısını kontrol et
WhatsApp instance'ının aktif olduğunu doğrula
Telefon numarasının doğru formatta olduğunu kontrol et

## 7. Son Geliştirmeler (23.01.2026) - Fiyat ve Kampanya İyileştirmeleri

### A. Özel Fiyat Sistemi Güvenliği
- **DOM State Yönetimi:** `campaign_logic.js` içinde `window.specialPriceItems` yerine DOM attribute (`data-special-items`) kullanılarak sayfa yenilemelerine karşı direnç sağlandı.
- **Miktar Değişikliği Koruması:** Kullanıcı sepetteki ürün miktarını değiştirdiğinde, eğer o ürüne özel fiyat uygulanmışsa güvenlik amacıyla fiyat otomatik olarak liste fiyatına çekilir ve iskonto iptal edilir.
- **Grup (Batch) İptali:** Kampanya ile birbirine bağlı ürünlerden (aynı `batch-id`) birinin koşulu bozulursa, gruptaki diğer tüm ürünlerin de kampanyası iptal edilir.

### B. Tutar Bazlı Kampanya Altyapısı
- **Veritabanı Genişletmesi:** `custom_campaigns` tablosuna `min_amount` (DECIMAL 15,2), `min_purchase_amount` ve `discount_rate` sütunları eklendi.
- **Hibrit Koşul Kontrolü:** `apply_manual_campaigns.php` API'si artık hem `min_quantity` (Adet) hem de `min_purchase_amount` (Tutar) kontrolü yapabiliyor.
    - Örn: "Temizlik Ekipmanları" için Min 1.500 € tutar koşulu tanımlandı.
    - Örn: "Ana Bayi Ek İskonto" için Min 5.000 € tutar koşulu tanımlandı.

### C. UI/UX İyileştirmeleri
- **Sıralı Kampanya Uygulama:** "Ana Bayi Ek İskonto" butonu, "Özel Fiyat" uygulanmadan önce **disable** durumdadır. Kullanıcıya "Önce Özel Fiyat!" uyarısı verilir.
- **Dinamik Aktivasyon:** Kullanıcı "Özel Fiyat" (Mavi) butonuna bastığında, başarılı olursa "Ek İskonto" (Sarı) butonu anında aktifleşir (Modal kapanmadan).
- **Akıllı Buton:** "Teklif Oluştur" sayfasındaki Ana Bayi butonu, sepetteki özel fiyatlı ürünlerin toplamını hesaplar.
    - Tutar < 5.000 € ise: "Kalan Tutar" gösterir, buton pasiftir.
    - Tutar >= 5.000 € ise: "Koşul Sağlandı" yazar, buton aktifleşir.
- **Para Formatı:** İskonto oranları ve fiyatlar TR formatında (örn: "5,00") gösterilir.